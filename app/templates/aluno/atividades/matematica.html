{% extends "base.html" %}
{% block title %}Matemática Tech - Desafio Ninja{% endblock %}

{% block content %}
<!-- Sons -->
<audio id="snd-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
<audio id="snd-wrong" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>

<div class="container py-2 py-md-4">
    <div id="game-container" class="card mx-auto shadow-2xl animate__animated animate__fadeIn"
        style="max-width: 850px; border-radius: 20px; border: 3px solid var(--accent); background: #050411; width: 100%;">

        <!-- Topo Gamificado -->
        <div class="card-header d-flex justify-content-between align-items-center py-3 py-md-4 px-3 px-md-5"
            style="background: rgba(0,0,0,0.4); border-bottom: 2px solid rgba(0,255,136,0.2);">
            <div class="d-flex align-items-center gap-3">
                <div class="score-hub pulse-mini">
                    <small class="d-block text-muted">PONTOS</small>
                    <span id="score-badge" class="h3 m-0 text-accent fw-bold font-orbitron">0</span>
                </div>
                <div class="combo-hub d-none" id="combo-container">
                    <small class="d-block text-warning">COMBO!</small>
                    <span id="combo-text" class="h4 m-0 text-warning fw-bold">x1</span>
                </div>
            </div>

            <div class="text-center">
                <h2 class="font-orbitron text-white mb-0" style="letter-spacing: 2px;">MATEMÁTICA <span
                        class="text-accent">TECH</span></h2>
                <span class="badge bg-dark border border-accent2 text-accent2" id="difficulty-badge">NÍVEL: FÁCIL</span>
            </div>

            <div class="timer-hub">
                <div class="circular-timer">
                    <span id="timer-badge" class="h4 m-0 font-orbitron">30</span>
                </div>
            </div>
        </div>

        <!-- Tela de Jogo -->
        <div class="card-body p-5 text-center" id="play-screen">
            <div class="progress-wrapper mb-5">
                <div class="progress-label d-flex justify-content-between mb-2">
                    <span class="text-muted"><i class="bi bi-graph-up"></i> PROGRESSO DA ARENA</span>
                    <span id="progress-text" class="text-accent">0/20</span>
                </div>
                <div class="progress"
                    style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: visible;">
                    <div id="bar-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-accent"
                        role="progressbar" style="width: 0%; border-radius: 10px; box-shadow: 0 0 15px var(--accent);">
                    </div>
                </div>
            </div>

            <div id="question-box" class="animate__animated">
                <p id="op-label" class="text-accent2 fw-bold text-uppercase mb-2" style="letter-spacing: 3px;">OPERAÇÃO
                    DETECTADA</p>
                <h1 id="question-text" class="display-1 fw-black text-white mb-5 font-orbitron"
                    style="font-size: 5.5rem; text-shadow: 0 0 30px rgba(255,255,255,0.2);">? + ?</h1>
            </div>

            <div class="row g-4 justify-content-center" id="options-container">
                <!-- Opções via JS -->
            </div>
        </div>

        <!-- Tela de Resultado Customizada -->
        <div class="card-body p-5 text-center d-none" id="result-screen">
            <div class="animate__animated animate__backInDown">
                <div class="result-icon-wrapper mb-4">
                    <i class="bi bi-star-fill text-warning animate__animated animate__infinite animate__pulse"
                        style="font-size: 6rem;"></i>
                </div>
                <h1 class="display-4 font-orbitron text-accent mb-2">PONTUAÇÃO SUPREMA!</h1>
                <p class="fs-4 text-muted mb-5">Seu raciocínio lógico está em outra dimensão.</p>

                <div class="row g-3 g-md-4 justify-content-center mb-4 mb-md-5">
                    <div class="col-6 col-md-4">
                        <div class="final-stat-card p-3 p-md-4">
                            <i class="bi bi-lightning-fill text-accent fs-2"></i>
                            <h2 id="final-xp" class="mb-0">0</h2>
                            <small class="d-block text-uppercase" style="font-size: 0.65rem;">XP</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4">
                        <div class="final-stat-card p-3 p-md-4">
                            <i class="bi bi-coin text-warning fs-2"></i>
                            <h2 id="final-tc" class="mb-0">0</h2>
                            <small class="d-block text-uppercase" style="font-size: 0.65rem;">TecCoins</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row justify-content-center gap-2 gap-md-3">
                    <button onclick="window.location.reload()"
                        class="btn btn-purple btn-lg px-4 font-orbitron w-100 w-md-auto">
                        <i class="bi bi-arrow-clockwise"></i> NOVO JOGO
                    </button>
                    <a href="{{ url_for('atividades.menu') }}"
                        class="btn btn-outline-accent btn-lg px-4 font-orbitron w-100 w-md-auto">
                        SAIR
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --accent: #00ff88;
        --accent2: #7c3aed;
    }

    body {
        background: #010108;
    }

    .font-orbitron {
        font-family: 'Orbitron', sans-serif;
    }

    .score-hub,
    .timer-hub {
        background: rgba(255, 255, 255, 0.05);
        padding: 10px 20px;
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .circular-timer {
        width: 60px;
        height: 60px;
        border: 3px solid var(--accent2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 15px rgba(124, 58, 237, 0.4);
    }

    .option-btn {
        background: linear-gradient(135deg, #161233 0%, #0a081a 100%);
        border: 2px solid rgba(124, 58, 237, 0.3);
        color: white;
        padding: 1.8rem;
        font-size: 2.2rem;
        font-weight: 800;
        border-radius: 20px;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .option-btn:hover {
        background: rgba(124, 58, 237, 0.2);
        border-color: var(--accent2);
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
    }

    .option-btn.correct {
        background: var(--accent) !important;
        color: #000 !important;
        border-color: #fff !important;
        box-shadow: 0 0 30px var(--accent);
    }

    .option-btn.wrong {
        background: #ef4444 !important;
        border-color: #fff !important;
        box-shadow: 0 0 30px #ef4444;
    }

    .final-stat-card {
        background: rgba(255, 255, 255, 0.03);
        padding: 2rem;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .final-stat-card h2 {
        font-size: 3rem;
        margin: 10px 0;
        font-family: 'Orbitron';
    }

    .final-stat-card i {
        font-size: 2.5rem;
    }

    .pulse-mini {
        animation: pulseAnim 2s infinite;
    }

    @keyframes pulseAnim {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.02);
        }

        100% {
            transform: scale(1);
        }
    }

    .shake {
        animation: shake 0.5s;
    }

    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-10px);
        }

        75% {
            transform: translateX(10px);
        }
    }

    /* Responsividade */
    @media (max-width: 768px) {
        #game-container {
            border-radius: 15px !important;
        }

        #question-text {
            font-size: 3rem !important;
            margin-bottom: 2rem !important;
        }

        .option-btn {
            padding: 1.2rem;
            font-size: 1.5rem;
            border-radius: 12px;
        }

        .score-hub,
        .timer-hub {
            padding: 5px 10px;
        }

        .card-header {
            padding: 1rem !important;
        }

        .card-body {
            padding: 1.5rem !important;
        }

        .display-4 {
            font-size: 1.8rem;
        }

        .final-stat-card {
            padding: 1.2rem !important;
        }

        .final-stat-card h2 {
            font-size: 1.8rem;
        }

        .font-orbitron {
            font-size: 0.9rem;
        }
    }

    @media (max-width: 480px) {
        #question-text {
            font-size: 2.2rem !important;
            margin-bottom: 1.5rem !important;
        }

        .option-btn {
            padding: 0.8rem;
            font-size: 1.2rem;
            margin-bottom: 0px;
        }

        .circular-timer {
            width: 45px;
            height: 45px;
            border-width: 2px;
        }

        #timer-badge {
            font-size: 1.1rem;
        }

        .score-hub span {
            font-size: 1.2rem !important;
        }

        .score-hub small {
            font-size: 0.6rem;
        }

        h2.font-orbitron {
            font-size: 1rem !important;
        }

        .progress-wrapper {
            margin-bottom: 1rem !important;
        }

        #op-label {
            font-size: 0.7rem;
        }

        .px-5 {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }
    }

    /* Ajuste para iPhones pequenos */
    @media (max-height: 700px) {
        .display-1 {
            font-size: 2.5rem !important;
        }

        .card-body {
            padding: 1rem !important;
        }
    }

    .h3 {
        font-size: 1.2rem;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    let score = 0;
    let combo = 0;
    let timer = 30;
    let currentQuestion = {};
    let isGameOver = false;
    let questionCount = 0;
    const totalQuestions = 20;
    let gameInterval;

    const sounds = {
        correct: document.getElementById('snd-correct'),
        wrong: document.getElementById('snd-wrong'),
        click: document.getElementById('snd-click')
    };

    function playSound(name) {
        sounds[name].currentTime = 0;
        sounds[name].play().catch(e => console.log('Sons desativados até interação'));
    }

    function generateRandomQuestion() {
        const difficulty = score < 50 ? 'EASY' : (score < 120 ? 'MEDIUM' : 'HARD');
        document.getElementById('difficulty-badge').innerText = `NÍVEL: ${difficulty}`;

        let a, b, op, ans;
        const ops = difficulty === 'EASY' ? ['+', '-'] : ['+', '-', '*', '/'];
        op = ops[Math.floor(Math.random() * ops.length)];

        if (difficulty === 'EASY') {
            a = Math.floor(Math.random() * 20) + 1;
            b = Math.floor(Math.random() * 20) + 1;
        } else if (difficulty === 'MEDIUM') {
            a = Math.floor(Math.random() * 50) + 10;
            b = Math.floor(Math.random() * 30) + 5;
        } else {
            a = Math.floor(Math.random() * 100) + 20;
            b = Math.floor(Math.random() * 50) + 10;
        }

        if (op === '+') { ans = a + b; }
        else if (op === '-') {
            if (a < b) [a, b] = [b, a];
            ans = a - b;
        }
        else if (op === '*') {
            if (difficulty === 'EASY') b = Math.floor(Math.random() * 5) + 2;
            ans = a * b;
        }
        else if (op === '/') {
            ans = Math.floor(Math.random() * 10) + 2;
            b = Math.floor(Math.random() * 10) + 2;
            a = ans * b;
        }

        const options = [ans];
        while (options.length < 4) {
            let fake = ans + (Math.floor(Math.random() * 10) - 5);
            if (fake !== ans && fake >= 0 && !options.includes(fake)) options.push(fake);
        }

        return {
            text: `${a} ${op === '*' ? 'x' : (op === '/' ? '÷' : op)} ${b}`,
            ans,
            options: options.sort(() => Math.random() - 0.5),
            type: op === '+' ? 'SOMA' : (op === '-' ? 'SUBTRAÇÃO' : (op === '*' ? 'MULTIPLICAÇÃO' : 'DIVISÃO'))
        };
    }

    function renderQuestion() {
        if (questionCount >= totalQuestions) {
            endGame();
            return;
        }

        currentQuestion = generateRandomQuestion();
        document.getElementById('question-text').innerText = currentQuestion.text + " = ?";
        document.getElementById('op-label').innerText = currentQuestion.type + " DETECTADA";

        const container = document.getElementById('options-container');
        container.innerHTML = '';

        currentQuestion.options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'col-6 col-md-3';
            div.innerHTML = `<button class="btn option-btn w-100" onclick="checkAnswer(this, ${opt})">${opt}</button>`;
            container.appendChild(div);
        });

        const progress = ((questionCount) / totalQuestions) * 100;
        document.getElementById('bar-progress').style.width = progress + "%";
        document.getElementById('progress-text').innerText = `${questionCount}/${totalQuestions}`;
    }

    function checkAnswer(btn, val) {
        if (isGameOver) return;
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.style.pointerEvents = 'none');

        if (val === currentQuestion.ans) {
            btn.classList.add('correct');
            playSound('correct');
            combo++;
            score += 10 * (1 + Math.floor(combo / 3));

            // Efeito Confetti se combo alto
            if (combo >= 3) {
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                document.getElementById('combo-container').classList.remove('d-none');
                document.getElementById('combo-text').innerText = `x${1 + Math.floor(combo / 3)}`;
            }

            document.getElementById('score-badge').innerText = score;
            document.getElementById('question-box').classList.add('animate__bounceIn');
        } else {
            btn.classList.add('wrong');
            playSound('wrong');
            document.getElementById('game-container').classList.add('shake');
            combo = 0;
            document.getElementById('combo-container').classList.add('d-none');

            // Mostrar a correta
            btns.forEach(b => {
                if (parseInt(b.innerText) === currentQuestion.ans) b.classList.add('correct');
            });
        }

        setTimeout(() => {
            document.getElementById('game-container').classList.remove('shake');
            document.getElementById('question-box').classList.remove('animate__bounceIn');
            questionCount++;
            renderQuestion();
        }, 900);
    }

    function startGame() {
        renderQuestion();
        gameInterval = setInterval(() => {
            timer--;
            document.getElementById('timer-badge').innerText = timer;
            if (timer <= 10) document.querySelector('.circular-timer').style.borderColor = '#ef4444';
            if (timer <= 0) endGame();
        }, 1000);
    }

    async function endGame() {
        isGameOver = true;
        clearInterval(gameInterval);
        document.getElementById('play-screen').classList.add('d-none');
        document.getElementById('result-screen').classList.remove('d-none');

        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        const finalTC = Math.floor(score / 5);
        document.getElementById('final-xp').innerText = score;
        document.getElementById('final-tc').innerText = finalTC;

        try {
            await fetch("{{ url_for('atividades.save_result') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    tipo: "matematica",
                    xp: score,
                    teccoins: finalTC,
                    obs: `Arena Ninja concluída! Score: ${score}, Questões: ${questionCount}.`
                })
            });
        } catch (e) { console.error(e); }
    }

    startGame();
</script>
{% endblock %}