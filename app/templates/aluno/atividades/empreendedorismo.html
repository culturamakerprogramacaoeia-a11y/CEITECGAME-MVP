{% extends "base.html" %}
{% block title %}Trilha do Empreendedorismo Digital{% endblock %}

{% block content %}
<audio id="snd-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
<audio id="snd-wrong" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>
<audio id="snd-step" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>

<div class="container py-2 py-md-4">
    <div id="game-container" class="card mx-auto shadow-2xl animate__animated animate__fadeIn"
        style="max-width: 900px; border-radius: 20px; border: none; background: #060515; min-height: 500px; width: 100%;">

        <!-- Header da Trilha -->
        <div
            class="p-3 p-md-4 bg-dark-purple border-bottom border-accent2 d-flex justify-content-between align-items-center">
            <div class="font-orbitron" style="max-width: 70%;">
                <h4 class="m-0 text-white" style="font-size: 0.9rem; line-height: 1.2;">TRILHA DO <span
                        class="text-accent2">EMPREENDEDORISMO</span></h4>
                <div class="d-flex gap-3 mt-1">
                    <span class="badge border border-success text-success" id="points-badge">XP: 0</span>
                    <span class="badge border border-info text-info" id="level-badge">LEVEL: 1</span>
                </div>
            </div>
            <div class="d-flex gap-2" id="trail-prog">
                <!-- Dots representados por JS -->
            </div>
        </div>

        <div class="card-body p-5">
            <div id="quiz-area" class="text-center">
                <div id="curiosity-box"
                    class="p-3 mb-4 rounded-4 bg-accent2-transparent animate__animated animate__lightSpeedInRight">
                    <small class="text-accent2 font-orbitron fw-bold letter-spacing-2">üí° VOC√ä SABIA?</small>
                    <p id="curiosity-text" class="text-white m-0 mt-2">O primeiro computador do mundo pesava 30
                        toneladas e ocupava 167m¬≤.</p>
                </div>

                <div class="question-container my-5">
                    <span class="text-muted d-block mb-2 text-uppercase font-orbitron smaller ls-2"
                        id="step-count">QUEST√ÉO 1 DE 10</span>
                    <h2 id="question-text" class="fw-bold text-white mb-4 display-6">O que significa a sigla MVP no
                        mundo das startups?</h2>
                </div>

                <div id="options-container" class="row g-3">
                    <!-- Bot√µes injetados via JS -->
                </div>
            </div>

            <!-- Tela de Conclus√£o -->
            <div id="conclusion-area" class="text-center d-none animate__animated animate__zoomIn">
                <div class="display-1 mb-3">üöÄ</div>
                <h1 class="font-orbitron display-4 text-accent mb-3">TRILHA CONCLU√çDA!</h1>
                <p class="fs-4 text-muted mb-5">Voc√™ agora domina os conceitos fundamentais da tecnologia e neg√≥cios
                    digitais.</p>

                <div class="row g-3 justify-content-center mb-4 mb-md-5">
                    <div class="col-8 col-md-5">
                        <div class="stat-box p-3 p-md-4 rounded-4 bg-dark-soft border border-accent">
                            <h2 id="final-xp" class="text-accent display-5 font-orbitron mb-0">0</h2>
                            <small class="text-muted text-uppercase" style="font-size: 0.7rem;">XP ADQUIRIDO</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex flex-column flex-md-row justify-content-center gap-2">
                    <button onclick="window.location.reload()"
                        class="btn btn-purple btn-lg px-4 font-orbitron w-100 w-md-auto">
                        <i class="bi bi-arrow-clockwise"></i> RECOME√áAR
                    </button>
                    <a href="{{ url_for('atividades.menu') }}"
                        class="btn btn-outline-accent btn-lg px-4 font-orbitron w-100 w-md-auto">
                        VOLTAR AO HUB
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-dark-purple {
        background: #110e2b;
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
    }

    .bg-accent2-transparent {
        background: rgba(124, 58, 237, 0.1);
        border-left: 4px solid var(--accent2);
    }

    .bg-dark-soft {
        background: rgba(255, 255, 255, 0.03);
    }

    .font-orbitron {
        font-family: 'Orbitron', sans-serif;
    }

    .ls-2 {
        letter-spacing: 2px;
    }

    .smaller {
        font-size: 0.75rem;
    }

    .choice-btn {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(124, 58, 237, 0.2);
        color: var(--text-main);
        text-align: left;
        padding: 1.5rem;
        border-radius: 15px;
        transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        font-weight: 500;
        font-size: 1.1rem;
    }

    .choice-btn:hover {
        background: rgba(124, 58, 237, 0.15);
        border-color: var(--accent2);
        transform: translateX(10px);
        color: #fff;
    }

    .choice-btn.correct {
        background: var(--accent) !important;
        color: #000 !important;
        font-weight: 700;
        border-color: #fff !important;
    }

    .choice-btn.wrong {
        background: #ef4444 !important;
        color: #fff;
        border-color: #fff !important;
    }

    .trail-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transition: 0.3s;
    }

    .trail-dot.active {
        background: var(--accent);
        box-shadow: 0 0 10px var(--accent);
    }

    /* Responsividade */
    @media (max-width: 768px) {
        #game-container {
            border-radius: 15px !important;
            min-height: 450px !important;
        }

        #question-text {
            font-size: 1.4rem !important;
            margin-bottom: 1.5rem !important;
        }

        .choice-btn {
            padding: 1rem;
            font-size: 1rem;
            border-radius: 12px;
        }

        .display-4 {
            font-size: 2rem;
        }

        .p-5 {
            padding: 1.5rem !important;
        }

        .font-orbitron h4 {
            font-size: 0.8rem !important;
        }

        #curiosity-box {
            font-size: 0.85rem;
            padding: 10px !important;
        }
    }

    @media (max-width: 480px) {
        #question-text {
            font-size: 1.2rem !important;
            line-height: 1.4;
        }

        .choice-btn {
            padding: 0.8rem;
            font-size: 0.95rem;
        }

        .bg-dark-purple {
            padding: 0.75rem !important;
        }

        .badge {
            font-size: 0.6rem !important;
            padding: 0.3em 0.5em;
        }

        .display-1 {
            font-size: 3rem !important;
        }

        .trail-dot {
            width: 8px;
            height: 8px;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    const trailData = [
        {
            q: "Quem criou o primeiro computador eletromec√¢nico do mundo?",
            o: ["Alan Turing", "Steve Jobs", "Konrad Zuse", "Ada Lovelace"],
            a: 2,
            c: "Konrad Zuse construiu o Z3 em 1941. Ele √© considerado o primeiro computador do mundo que era digital e program√°vel!"
        },
        {
            q: "O que significa a sigla MVP no mundo do empreendedorismo?",
            o: ["Most Valuable Player", "Minimum Viable Product", "Main Version Prototype", "Most Visible Product"],
            a: 1,
            c: "MVP √© a vers√£o mais simples de um produto para ser testada pelo mercado com o menor custo poss√≠vel."
        },
        {
            q: "Qual dessas linguagens de programa√ß√£o √© famosa por ser usada para ensinar l√≥gica a crian√ßas (blocos)?",
            o: ["Python", "JavaScript", "Scratch", "C++"],
            a: 2,
            c: "O Scratch foi criado pelo MIT e revolucionou o ensino de l√≥gica usando blocos de arrastar!"
        },
        {
            q: "A internet 'nasceu' de um projeto militar. Qual era o nome original dele?",
            o: ["ARPANET", "WWW", "Intranet", "GoogleNet"],
            a: 0,
            c: "A ARPANET foi a rede criada pelo Departamento de Defesa dos EUA em 1969, base da internet que temos hoje."
        },
        {
            q: "Qual empresa criou o sistema operacional Android em sua origem?",
            o: ["Google", "Samsung", "Android Inc.", "Microsoft"],
            a: 2,
            c: "Embora hoje seja do Google, o Android come√ßou em uma empresa independente chamada Android Inc. em 2003."
        },
        {
            q: "No empreendedorismo, o que significa 'Pivotar'?",
            o: ["Desistir do neg√≥cio", "Mudar drasticamente o foco da empresa", "Vender a empresa por milh√µes", "Contratar novos funcion√°rios"],
            a: 1,
            c: "Pivotar √© quando uma startup percebe que seu modelo atual n√£o funciona e decide mudar de dire√ß√£o estrat√©gica."
        },
        {
            q: "O termo 'Bug' veio de um inseto real que entrou em um computador. Quem popularizou o termo?",
            o: ["Bill Gates", "Grace Hopper", "Mark Zuckerberg", "Jeff Bezos"],
            a: 1,
            c: "Grace Hopper encontrou uma mariposa real (bug) causando falha em um computador Harvard Mark II em 1947!"
        },
        {
            q: "Qual √© a rede social que come√ßou apenas para estudantes da universidade de Harvard?",
            o: ["Instagram", "WhatsApp", "Facebook", "Twitter"],
            a: 2,
            c: "Mark Zuckerberg lan√ßou 'TheFacebook' em 2004 para que estudantes pudessem se conectar inicialmente em Harvard."
        }
    ];

    let currentStep = 0;
    let score = 0;
    const sounds = {
        correct: document.getElementById('snd-correct'),
        wrong: document.getElementById('snd-wrong'),
        step: document.getElementById('snd-step')
    };

    let shuffledTrail = [];

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initTrail() {
        // Criar c√≥pia e embaralhar as quest√µes
        shuffledTrail = shuffleArray([...trailData]).slice(0, 8); // Pegar 8 aleat√≥rias

        const prog = document.getElementById('trail-prog');
        prog.innerHTML = '';
        shuffledTrail.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = `trail-dot ${i === 0 ? 'active' : ''}`;
            prog.appendChild(dot);
        });
        renderStep();
    }

    function renderStep() {
        if (currentStep >= shuffledTrail.length) {
            finishTrail();
            return;
        }

        const data = shuffledTrail[currentStep];
        document.getElementById('step-count').innerText = `QUEST√ÉO ${currentStep + 1} DE ${shuffledTrail.length}`;
        document.getElementById('question-text').innerText = data.q;
        document.getElementById('curiosity-text').innerText = data.c;

        // Reset da anima√ß√£o de curiosidade
        const curBox = document.getElementById('curiosity-box');
        curBox.classList.remove('animate__lightSpeedInRight');
        void curBox.offsetWidth;
        curBox.classList.add('animate__lightSpeedInRight');

        const container = document.getElementById('options-container');
        container.innerHTML = '';

        // Mapear op√ß√µes com seus √≠ndices originais para checar resposta
        let optionsWithIdx = data.o.map((text, idx) => ({ text, idx }));
        shuffleArray(optionsWithIdx);

        optionsWithIdx.forEach(opt => {
            const col = document.createElement('div');
            col.className = 'col-12';
            // Passamos o √≠ndice original (idx) para a checagem
            col.innerHTML = `<button class="btn choice-btn w-100" onclick="checkChoice(this, ${opt.idx})">${opt.text}</button>`;
            container.appendChild(col);
        });

        // Update dots
        const dots = document.querySelectorAll('.trail-dot');
        dots.forEach((d, i) => i <= currentStep ? d.classList.add('active') : d.classList.remove('active'));
    }

    function checkChoice(btn, selectedIdx) {
        const correctIdx = shuffledTrail[currentStep].a;
        const btns = document.querySelectorAll('.choice-btn');

        // Desabilitar todos para evitar m√∫ltiplos cliques
        btns.forEach(b => b.style.pointerEvents = 'none');

        if (selectedIdx === correctIdx) {
            btn.classList.add('correct');
            sounds.correct.play().catch(e => { });
            score += 20;
            document.getElementById('points-badge').innerText = `XP: ${score}`;
        } else {
            btn.classList.add('wrong');
            sounds.wrong.play().catch(e => { });
            // Mostrar a correta entre os bot√µes vis√≠veis
            btns.forEach(b => {
                // Como n√£o temos o √≠ndice original f√°cil aqui (pois o HTML √© string), 
                // vamos buscar pelo texto da op√ß√£o correta guardada no shuffledTrail
                if (b.innerText === shuffledTrail[currentStep].o[correctIdx]) {
                    b.classList.add('correct');
                }
            });
        }

        setTimeout(() => {
            currentStep++;
            sounds.step.play().catch(e => { });
            renderStep();
        }, 1500);
    }

    async function finishTrail() {
        document.getElementById('quiz-area').classList.add('d-none');
        document.getElementById('conclusion-area').classList.remove('d-none');
        confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });

        const tc = Math.floor(score / 5);
        document.getElementById('final-xp').innerText = score;

        try {
            await fetch("{{ url_for('atividades.save_result') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    tipo: "empreendedorismo",
                    xp: score,
                    teccoins: tc,
                    obs: `Trilha do Empreendedorismo conclu√≠da com ${score} de XP.`
                })
            });
        } catch (e) { console.error(e); }
    }

    initTrail();
</script>
{% endblock %}