{% extends "base.html" %}
{% block title %}Trilha da Startup Unic√≥rnio{% endblock %}

{% block content %}
<audio id="snd-success" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" preload="auto"></audio>
<audio id="snd-fail" src="https://assets.mixkit.co/active_storage/sfx/2021/2021-preview.mp3" preload="auto"></audio>
<audio id="snd-path" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>

<div class="container py-4">
    <!-- Overlay de Rea√ß√£o Game-Feel -->
    <div id="reaction-overlay" class="reaction-text animate__animated d-none">BOOOM!</div>

    <div id="sim-container" class="card mx-auto overflow-hidden animate__animated animate__zoomIn"
        style="max-width: 950px; border-radius: 30px; border: none; background: #08071a; min-height: 600px; box-shadow: 0 0 50px rgba(124, 58, 237, 0.2);">

        <!-- Header Din√¢mico -->
        <div class="p-4 d-flex justify-content-between align-items-center bg-dark-purple border-bottom border-accent2">
            <div class="font-orbitron">
                <h4 class="m-0 text-white">TECH VENTURE <span class="text-accent2">TRAIL</span></h4>
                <div class="d-flex gap-3 mt-2">
                    <span class="badge border border-success text-success" id="val-badge">Valuation: $0.1M</span>
                    <span class="badge border border-warning text-warning" id="energy-badge">Energia: 100%</span>
                </div>
            </div>
            <div class="progress-trail d-flex gap-2" id="trail-dots">
                <!-- Dots representados por JS -->
            </div>
        </div>

        <div class="card-body p-0 position-relative" id="main-sim-screen">
            <!-- Camada de Fundo Din√¢mica -->
            <div id="sim-bg-layer" class="bg-gradient-tech"></div>

            <div class="row g-0 h-100 position-relative" style="z-index: 2;">
                <!-- Card de Pergunta/A√ß√£o -->
                <div class="col-md-7 p-5 d-flex flex-column justify-content-center">
                    <div id="step-content">
                        <span class="badge bg-accent2 mb-3 px-3 py-2 text-uppercase letter-spacing-2" id="step-tag">FASE
                            1: CONCEP√á√ÉO</span>
                        <h1 id="step-title" class="display-5 text-white fw-bold mb-4 font-orbitron">IDEIA DE MILH√ïES?
                        </h1>
                        <p id="step-desc" class="fs-4 text-muted mb-5">
                            Voc√™ acaba de descobrir uma falha no mercado de log√≠stica global. Como voc√™ pretende atacar
                            esse problema?
                        </p>

                        <div id="choices-container" class="d-grid gap-3">
                            <!-- Bot√µes de a√ß√£o via JS -->
                        </div>
                    </div>
                </div>

                <!-- Lado Visual - Dashboard da Startup -->
                <div class="col-md-5 p-5 bg-black-soft d-flex flex-column align-items-center justify-content-center">
                    <div id="visual-report" class="text-center">
                        <div class="unicorn-icon animate__animated animate__infinite animate__pulse mb-4">ü¶Ñ</div>
                        <h3 class="font-orbitron text-accent">$ <span id="valuation-counter">100,000</span></h3>
                        <p class="text-muted">VALUATION ESTIMADO</p>

                        <div class="mt-5 text-start w-100 p-3 bg-dark rounded-4 border border-accent2">
                            <h6 class="text-accent2 font-orbitron smaller"><i class="bi bi-terminal"></i> LOG DE
                                MERCADO:</h6>
                            <div id="market-log" class="small text-muted" style="height: 100px; overflow-y: auto;">
                                > Sistema reiniciado...<br>
                                > Aguardando primeira decis√£o estrat√©gica...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tela de Vit√≥ria √âpica -->
        <div class="card-body p-5 text-center d-none" id="sim-win-screen">
            <div class="animate__animated animate__bounceIn">
                <div class="display-1 mb-3">üíé</div>
                <h1 class="font-orbitron display-3 text-accent shimmer-text">STARTUP UNIC√ìRNIO!</h1>
                <p class="fs-3 text-muted">Voc√™ revolucionou o mercado e atingiu 1 Bilh√£o em valuation.</p>

                <div class="row g-4 my-5 justify-content-center">
                    <div class="col-md-4">
                        <div class="p-4 bg-dark-soft rounded-4 border border-accent">
                            <h2 id="sim-xp" class="text-accent display-4 font-orbitron">0</h2>
                            <small class="text-muted">XP ADQUIRIDO (N√çVEL LEND√ÅRIO)</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-4 bg-dark-soft rounded-4 border border-warning">
                            <h2 id="sim-tc" class="text-warning display-4 font-orbitron">0</h2>
                            <small class="text-muted">TECCOINS BONUS</small>
                        </div>
                    </div>
                </div>

                <a href="{{ url_for('atividades.menu') }}"
                    class="btn btn-purple btn-xl px-5 py-3 font-orbitron fs-4 animate__animated animate__pulse animate__infinite">
                    CELEBRAR NO HUB!
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-dark-purple {
        background: #130f2b;
    }

    .bg-black-soft {
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
    }

    .bg-gradient-tech {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, #7c3aed33, transparent),
            radial-gradient(circle at bottom left, #00ff8811, transparent);
        pointer-events: none;
    }

    .font-orbitron {
        font-family: 'Orbitron', sans-serif;
    }

    .letter-spacing-2 {
        letter-spacing: 2px;
    }

    .choice-btn {
        background: #1e1b4b;
        border: 2px solid rgba(124, 58, 237, 0.4);
        color: white;
        text-align: left;
        padding: 1.5rem;
        border-radius: 18px;
        transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        font-weight: 600;
        position: relative;
        overflow: hidden;
    }

    .choice-btn:hover {
        background: var(--accent2);
        border-color: #fff;
        transform: scale(1.03) rotate(-1deg);
        box-shadow: 0 10px 40px rgba(124, 58, 237, 0.5);
    }

    .choice-btn::after {
        content: 'SELECT';
        position: absolute;
        right: 20px;
        opacity: 0;
        transition: 0.3s;
        font-family: 'Orbitron';
        font-size: 0.7rem;
    }

    .choice-btn:hover::after {
        opacity: 0.8;
    }

    .unicorn-icon {
        font-size: 8rem;
        filter: drop-shadow(0 0 30px #7c3aed);
    }

    .reaction-text {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 8rem;
        font-family: 'Orbitron';
        font-weight: 900;
        color: #fff;
        text-shadow: 0 0 50px #7c3aed;
        z-index: 9999;
        pointer-events: none;
    }

    .shimmer-text {
        background: linear-gradient(92deg, #00ff88 0%, #fff 50%, #00ff88 100%);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 2s linear infinite;
    }

    @keyframes shimmer {
        to {
            background-position: 200% center;
        }
    }

    .trail-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
    }

    .trail-dot.active {
        background: var(--accent) !important;
        box-shadow: 0 0 10px var(--accent);
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    let simData = {
        valuation: 100000,
        energy: 100,
        currentStep: 0,
        history: []
    };

    const storySteps = [
        {
            tag: "CONCEP√á√ÉO",
            title: "MVP OU PERFEI√á√ÉO?",
            desc: "Seu prot√≥tipo b√°sico j√° funciona, mas n√£o est√° bonito. O que voc√™ faz?",
            choices: [
                { text: "Lan√ßar AGORA e coletar feedback real", impact: { v: 200000, e: -10, r: "BOOOM! FEEDBACK R√ÅPIDO!" }, next: 1 },
                { text: "Passar 6 meses refinando o design", impact: { v: -50000, e: -30, r: "LENTO... MERCADO ESFRIOU!" }, next: 1 },
                { text: "Tentar pivotar para outra ideia", impact: { v: 0, e: -5, r: "PIVOTANDO..." }, next: 0 }
            ]
        },
        {
            tag: "CRESCIMENTO",
            title: "INVESTIMENTO ANJO",
            desc: "Um grupo de investidores ofereceu 500k por 20% da sua empresa. Aceita?",
            choices: [
                { text: "ACEITAR: Dinheiro no caixa para escalar!", impact: { v: 500000, e: 20, r: "POOOOKER! CAIXA CHEIO!" }, next: 2 },
                { text: "RECUSAR: Manter controle total e ir devagar", impact: { v: 50000, e: -40, r: "BOOTSTRAPPING!" }, next: 2 }
            ]
        },
        {
            tag: "A ESCALA",
            title: "VIRALIZOU! E AGORA?",
            desc: "Seu servidor caiu devido ao excesso de acessos. O mercado est√° em p√¢nico!",
            choices: [
                { text: "Virar a noite programando (HER√ìI)", impact: { v: 1500000, e: -50, r: "GOD MODE!" }, next: 3 },
                { text: "Delegar para uma consultoria cara", impact: { v: -200000, e: 10, r: "CUSTO ALTO!" }, next: 3 }
            ]
        },
        {
            tag: "DOMINA√á√ÉO",
            title: "CONCORRENTE GIGANTE",
            desc: "A Google anunciou um produto similar ao seu. Qual sua rea√ß√£o?",
            choices: [
                { text: "Anunciar parceria de integra√ß√£o", impact: { v: 500000000, e: 30, r: "M&A √Ä VISTA!" }, next: 4 },
                { text: "Processar por viola√ß√£o de patente", impact: { v: -10000000, e: -20, r: "TRETA JUR√çDICA!" }, next: 4 }
            ]
        }
    ];

    function logMarket(msg) {
        const log = document.getElementById('market-log');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }

    function showReaction(text) {
        const overlay = document.getElementById('reaction-overlay');
        overlay.innerText = text;
        overlay.classList.remove('d-none', 'animate__zoomIn');
        void overlay.offsetWidth; // trigger reflow
        overlay.classList.add('animate__zoomIn');

        setTimeout(() => { overlay.classList.add('d-none'); }, 1500);
    }

    function renderTrail() {
        const trail = document.getElementById('trail-dots');
        trail.innerHTML = '';
        for (let i = 0; i < storySteps.length + 1; i++) {
            const dot = document.createElement('div');
            dot.className = `trail-dot ${i <= simData.currentStep ? 'active' : ''}`;
            trail.appendChild(dot);
        }
    }

    function renderStep() {
        if (simData.currentStep >= storySteps.length) {
            finishSim();
            return;
        }

        renderTrail();
        const step = storySteps[simData.currentStep];
        document.getElementById('step-tag').innerText = `FASE ${simData.currentStep + 1}: ${step.tag}`;
        document.getElementById('step-title').innerText = step.title;
        document.getElementById('step-desc').innerText = step.desc;

        const container = document.getElementById('choices-container');
        container.innerHTML = '';

        step.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerHTML = `<i class="bi bi-rocket-takeoff me-2"></i> ${c.text}`;
            btn.onclick = () => makeChoice(c);
            container.appendChild(btn);
        });
    }

    function makeChoice(choice) {
        document.getElementById('snd-path').play();
        simData.valuation += choice.impact.v;
        simData.energy += choice.impact.e;
        simData.currentStep = choice.next;

        showReaction(choice.impact.r);
        logMarket(`Decidido: ${choice.text}`);
        logMarket(`Valuation agora em $${(simData.valuation / 1000000).toFixed(2)}M`);

        // Update visual counters
        updateVisuals();

        if (simData.energy <= 0) {
            alert("Burnout! Voc√™ faliu por falta de energia.");
            window.location.reload();
            return;
        }

        renderStep();
    }

    function updateVisuals() {
        document.getElementById('val-badge').innerText = `Valuation: $${(simData.valuation / 1000000).toFixed(2)}M`;
        document.getElementById('energy-badge').innerText = `Energia: ${simData.energy}%`;
        document.getElementById('valuation-counter').innerText = simData.valuation.toLocaleString();
    }

    async function finishSim() {
        document.getElementById('main-sim-screen').classList.add('d-none');
        document.getElementById('sim-win-screen').classList.remove('d-none');
        document.getElementById('snd-success').play();

        confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });

        const xp = Math.floor(simData.valuation / 1000000) + 200;
        const tc = Math.floor(xp / 5);

        document.getElementById('sim-xp').innerText = xp;
        document.getElementById('sim-tc').innerText = tc;

        try {
            await fetch("{{ url_for('atividades.save_result') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    tipo: "empreendedorismo",
                    xp: xp,
                    teccoins: tc,
                    obs: `Startuper Unic√≥rnio! Valuation final: $${(simData.valuation / 1000000).toFixed(2)}M.`
                })
            });
        } catch (e) { console.error(e); }
    }

    renderStep();
</script>
{% endblock %}