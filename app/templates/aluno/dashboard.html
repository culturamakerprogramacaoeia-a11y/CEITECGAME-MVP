{% extends "base.html" %}
{% block title %}Meu Dashboard{% endblock %}

{% block content %}
<div class="page-title glow-text">
  <i class="bi bi-controller"></i> MEU PAINEL
</div>

<!-- Status do jogador -->
<div class="row g-3 mb-4">
  <!-- Card principal: N√≠vel + XP -->
  <div class="col-12 col-md-6">
    <div class="card h-100" style="border-color:rgba(0,255,136,0.4);">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <p style="color:var(--text-muted); font-size:0.8rem; letter-spacing:2px; margin:0;">JOGADOR</p>
            <h4 style="font-family:'Orbitron',sans-serif; color:var(--text-main); margin:0.2rem 0;">
              {{ current_user.nome }}
            </h4>
          </div>
          <span class="badge-nivel nivel-{{ nivel_nome }}" style="font-size:0.9rem; padding:0.4em 1em;">
            {{ nivel_nome }}
          </span>
        </div>

        <!-- Barra de XP -->
        <div class="mb-2">
          <div class="d-flex justify-content-between mb-1">
            <small style="color:var(--accent);">‚ö° {{ xp }} XP</small>
            {% if xp_prox %}
            <small style="color:var(--text-muted);">Pr√≥ximo n√≠vel: {{ xp_prox }} XP</small>
            {% else %}
            <small style="color:var(--accent);">N√çVEL M√ÅXIMO üèÜ</small>
            {% endif %}
          </div>
          <div class="xp-bar-container">
            <div class="xp-bar-fill" style="width: {{ progresso }}%;"></div>
          </div>
        </div>
        <small style="color:var(--text-muted);">{{ progresso }}% para o pr√≥ximo n√≠vel</small>
      </div>
    </div>
  </div>

  <!-- Cards XP e TecCoins -->
  <div class="col-6 col-md-3">
    <div class="stat-card h-100">
      <div class="stat-icon">‚ö°</div>
      <div class="stat-value">{{ xp }}</div>
      <div class="stat-label">XP Total</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="stat-card h-100">
      <div class="stat-icon">ü™ô</div>
      <div class="stat-value" style="color:#f59e0b;">{{ tc }}</div>
      <div class="stat-label">TecCoins</div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Hist√≥rico recente -->
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clock-history"></i> √öLTIMAS PONTUA√á√ïES</span>
        <a href="{{ url_for('aluno.historico') }}"
          style="font-size:0.75rem; color:var(--accent); text-decoration:none;">
          Ver tudo ‚Üí
        </a>
      </div>
      <div class="card-body p-0">
        {% if historico %}
        <table class="table-dark-custom w-100">
          <thead>
            <tr>
              <th>MISS√ÉO</th>
              <th>XP</th>
              <th>TECCOINS</th>
              <th>DATA</th>
            </tr>
          </thead>
          <tbody>
            {% for p in historico %}
            <tr>
              <td>
                <strong>{{ p.missao.titulo }}</strong><br>
                <small style="color:var(--text-muted);">{{ p.missao.categoria }}</small>
              </td>
              <td><span class="xp-badge">+{{ p.xp_recebido }}</span></td>
              <td><span class="tc-badge">+{{ p.teccoins_recebido }}</span></td>
              <td style="color:var(--text-muted); font-size:0.8rem;">
                {{ p.data.strftime('%d/%m/%Y') }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-4 text-center" style="color:var(--text-muted);">
          <i class="bi bi-inbox" style="font-size:2rem; color:var(--accent2);"></i>
          <p class="mt-2 mb-0">Nenhuma pontua√ß√£o ainda. Conclua miss√µes!</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Ranking da turma -->
  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bar-chart-fill"></i> RANKING DA TURMA</span>
        <a href="{{ url_for('aluno.ranking') }}" style="font-size:0.75rem; color:var(--accent); text-decoration:none;">
          Ver tudo ‚Üí
        </a>
      </div>
      <div class="card-body p-0">
        {% if ranking %}
        <table class="table-dark-custom w-100">
          <thead>
            <tr>
              <th>#</th>
              <th>ALUNO</th>
              <th>XP</th>
            </tr>
          </thead>
          <tbody>
            {% for a in ranking %}
            <tr {% if a.id==current_user.id %} style="background:rgba(0,255,136,0.07);" {% endif %}>
              <td style="text-align:center;">
                {% if loop.index == 1 %}<span class="rank-1">ü•á</span>
                {% elif loop.index == 2 %}<span class="rank-2">ü•à</span>
                {% elif loop.index == 3 %}<span class="rank-3">ü•â</span>
                {% else %}<small style="color:var(--text-muted);">{{ loop.index }}</small>
                {% endif %}
              </td>
              <td>
                {{ a.nome }}
                {% if a.id == current_user.id %}
                <span style="color:var(--accent); font-size:0.75rem;"> (voc√™)</span>
                {% endif %}
              </td>
              <td><span class="xp-badge">{{ a.xp_total }}</span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="p-3 text-center" style="color:var(--text-muted);">
          Sem dados de ranking.
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Atalhos -->
    <div class="card mt-3" style="border: 1px solid var(--accent2);">
      <div class="card-body p-3">
        <a href="{{ url_for('atividades.menu') }}" class="btn btn-purple w-100 mb-2">
          <i class="bi bi-controller"></i> JOGAR E GANHAR XP üöÄ
        </a>
        <div class="d-flex gap-2 flex-wrap">
          <a href="{{ url_for('aluno.loja') }}" class="btn btn-accent btn-sm flex-grow-1">
            <i class="bi bi-shop"></i> Loja
          </a>

          <a href="{{ url_for('aluno.historico') }}" class="btn btn-outline-accent btn-sm flex-grow-1">
            <i class="bi bi-clock-history"></i> Hist√≥rico
          </a>
          <a href="{{ url_for('aluno.meus_resgates') }}" class="btn btn-outline-accent btn-sm flex-grow-1">
            <i class="bi bi-bag"></i> Resgates
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endblock %}