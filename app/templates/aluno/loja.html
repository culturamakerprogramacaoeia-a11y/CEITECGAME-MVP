{% extends "base.html" %}
{% block title %}Loja de Recompensas{% endblock %}

{% block content %}
<div class="page-title glow-text">
  <i class="bi bi-shop"></i> LOJA DE RECOMPENSAS
</div>

<!-- Saldo atual -->
<div class="card mb-4" style="border-color:rgba(245,158,11,0.4);">
  <div class="card-body p-3 d-flex align-items-center gap-4">
    <div>
      <p style="color:var(--text-muted); font-size:0.8rem; letter-spacing:1px; margin:0;">SEU SALDO</p>
      <span style="font-family:'Orbitron',sans-serif; font-size:1.8rem; color:#f59e0b; font-weight:900;">
        ü™ô {{ current_user.teccoins_total }}
      </span>
      <span style="color:var(--text-muted); font-size:0.85rem; margin-left:0.5rem;">TecCoins</span>
    </div>
    <div style="border-left:1px solid var(--border); padding-left:1.5rem;">
      <p style="color:var(--text-muted); font-size:0.8rem; letter-spacing:1px; margin:0;">SEU N√çVEL</p>
      <span class="badge-nivel nivel-{{ current_user.nivel }}" style="font-size:0.95rem; padding:0.3em 1em;">
        {{ current_user.nivel }}
      </span>
    </div>
  </div>
</div>

<!-- Lista de recompensas -->
{% if recompensas %}
{% set nivel_nomes = {1:'Explorador', 2:'Programador', 3:'Maker', 4:'Engenheiro', 5:'Mentor'} %}
<div class="row g-3">
  {% for r in recompensas %}
  {% set pode_nivel = current_user.nivel_numero >= r.nivel_minimo %}
  {% set pode_tc = current_user.teccoins_total >= r.custo_teccoins %}
  {% set pode_resgatar = pode_nivel and pode_tc %}
  {% set ja_pediu = r.id in meus_resgates_pendentes %}

  <div class="col-12 col-sm-6 col-lg-4">
    <div class="card h-100"
         style="border-color: {{ 'rgba(0,255,136,0.4)' if pode_resgatar else 'rgba(255,255,255,0.08)' }};
                opacity: {{ '1' if pode_resgatar or ja_pediu else '0.7' }};">
      <div class="card-body p-3 d-flex flex-column">
        <h6 style="font-family:'Orbitron',sans-serif; color:var(--accent); font-size:0.85rem; margin-bottom:0.5rem;">
          üéÅ {{ r.nome }}
        </h6>
        {% if r.descricao %}
        <p style="color:var(--text-muted); font-size:0.83rem; flex-grow:1;">{{ r.descricao }}</p>
        {% endif %}

        <div class="d-flex gap-2 mb-3 flex-wrap">
          <span class="tc-badge">
            <i class="bi bi-coin"></i> {{ r.custo_teccoins }} TC
            {% if not pode_tc %}
            <small style="color:#f87171;">(insuf.)</small>
            {% endif %}
          </span>
          <span class="badge-nivel nivel-{{ nivel_nomes.get(r.nivel_minimo, 'Explorador') }}">
            {{ nivel_nomes.get(r.nivel_minimo, '?') }}
            {% if not pode_nivel %}üîí{% endif %}
          </span>
        </div>

        {% if ja_pediu %}
        <button class="btn btn-sm w-100" disabled
                style="background:rgba(245,158,11,0.15); color:#fbbf24; border:1px solid rgba(245,158,11,0.3);">
          ‚è≥ Aguardando aprova√ß√£o
        </button>
        {% elif pode_resgatar %}
        <form method="POST" action="{{ url_for('aluno.resgatar', recompensa_id=r.id) }}">
          <button type="submit" class="btn btn-accent btn-sm w-100">
            <i class="bi bi-bag-plus-fill"></i> Resgatar
          </button>
        </form>
        {% else %}
        <button class="btn btn-sm w-100" disabled
                style="background:rgba(255,255,255,0.05); color:var(--text-muted); border:1px solid rgba(255,255,255,0.1);">
          <i class="bi bi-lock-fill"></i> Bloqueado
        </button>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="card">
  <div class="card-body text-center py-5" style="color:var(--text-muted);">
    <i class="bi bi-shop" style="font-size:3rem; color:var(--accent2);"></i>
    <p class="mt-2">Nenhuma recompensa dispon√≠vel ainda.</p>
  </div>
</div>
{% endif %}
{% endblock %}
